{% extends "base.html" %}

{% block title %}Movie Collections - PlexiTrack{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold text-white"><i class="bi bi-film mr-2"></i> Plex Movie Collections</h1>
        <button class="bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded-lg flex items-center" id="run-movie-scan">
            <span class="scan-text"><i class="bi bi-arrow-clockwise mr-2"></i> Scan Movie Library</span>
            <span class="scan-progress hidden">
                <span class="spinner-border spinner-border-sm mr-2" role="status" aria-hidden="true"></span>
                <span>Scanning...</span>
            </span>
        </button>
    </div>

    <!-- Search and Filter -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between mb-6 gap-4">
        <div class="flex-grow">
            <input type="text" id="movie-search" class="shadow appearance-none border border-gray-700 rounded w-full py-2 px-3 bg-gray-900 text-white leading-tight focus:outline-none focus:shadow-outline focus:border-blue-500" placeholder="Search for a collection or movie...">
        </div>
        <div class="flex items-center">
            <input type="checkbox" id="filter-missing" class="form-checkbox h-5 w-5 text-blue-600 bg-gray-900 border-gray-700 rounded focus:ring-blue-500">
            <label for="filter-missing" class="ml-2 text-gray-300">Show only collections with missing movies</label>
        </div>
    </div>

    <!-- Progress bar and scan information -->
    <div class="progress-container hidden mb-6" id="movieProgressContainer">
        <div class="flex justify-between mb-1">
            <div class="scan-info text-sm font-medium text-gray-400" id="movieScanStatus">Starting scan...</div>
            <div class="scan-info text-sm font-medium text-gray-400" id="movieScanProgress">0%</div>
        </div>
        <div class="w-full bg-gray-700 rounded-full h-2.5 mb-2">
            <div class="bg-blue-600 h-2.5 rounded-full" id="movieScanProgressBar" style="width: 0%" role="progressbar" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100"></div>
        </div>
        <div class="text-center">
            <button class="bg-red-600 hover:bg-red-700 text-white font-bold py-1 px-3 rounded-lg text-sm" id="stopMovieScanBtn">
                <i class="bi bi-stop-fill mr-1"></i> Stop Scan
            </button>
            <small class="text-gray-500 ml-2">Progress so far will be saved</small>
        </div>
    </div>

    <div id="collections-container">
    {% if collections %}
        {% for item in collections %}
            <div class="bg-gray-800 rounded-lg shadow-lg mb-6 collection-item" data-has-missing="{{ 'true' if item.has_missing_movies else 'false' }}">
                <div class="p-4 bg-gray-700 rounded-t-lg">
                    <h2 class="text-2xl font-bold text-white collection-title">{{ item.collection.name }}</h2>
                </div>
                <div class="p-4">
                    <div class="grid grid-cols-2 sm:grid-cols-4 md:grid-cols-6 lg:grid-cols-8 xl:grid-cols-10 gap-4">
                        {% for movie in item.movies %}
                            <div class="relative movie-card cursor-pointer" data-movie-details='{{ movie | tojson }}' data-movie-title="{{ movie.title | lower }}">
                                <img src="{{ movie.poster_url }}" class="w-full h-auto object-cover rounded-lg" alt="{{ movie.title }} poster" onerror="this.onerror=null;this.src='https://via.placeholder.com/500x750.png?text=No+Poster';">
                                {% if not movie.owned %}
                                <div class="absolute inset-0 bg-black opacity-60 rounded-lg"></div>
                                <div class="absolute inset-0 flex items-center justify-center">
                                    <span class="text-white text-lg font-bold">Missing</span>
                                </div>
                                {% endif %}
                            </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        {% endfor %}
    {% else %}
        <div class="bg-gray-800 p-6 rounded-lg shadow-lg text-center">
            <p class="text-gray-400 text-lg">No collections found. Run a scan to check.</p>
        </div>
    {% endif %}
    </div>
</div>

<!-- Movie Details Modal -->
<div id="movie-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 hidden">
    <div class="bg-gray-800 rounded-lg shadow-lg p-6 w-full max-w-3xl max-h-screen overflow-y-auto">
        <div class="flex justify-between items-center mb-4">
            <h2 id="modal-title" class="text-2xl font-bold text-white"></h2>
            <button id="modal-close" class="text-gray-400 hover:text-white">&times;</button>
        </div>
        <div id="modal-content" class="text-white"></div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Modal script
        const modal = document.getElementById('movie-modal');
        const modalClose = document.getElementById('modal-close');
        const modalTitle = document.getElementById('modal-title');
        const modalContent = document.getElementById('modal-content');

        document.querySelectorAll('.movie-card').forEach(card => {
            card.addEventListener('click', () => {
                const movieDetails = JSON.parse(card.dataset.movieDetails);
                
                modalTitle.textContent = movieDetails.title;
                modalContent.innerHTML = `
                    <div class="flex flex-col md:flex-row gap-6">
                        <div class="md:w-1/3">
                            <img src="${movieDetails.poster_url}" class="w-full h-auto object-cover rounded-lg">
                        </div>
                        <div class="md:w-2/3">
                            <p class="text-gray-300 mb-4">${movieDetails.overview}</p>
                            <p><strong>Release Date:</strong> ${movieDetails.release_date || 'N/A'}</p>
                            <p><strong>Studio:</strong> ${movieDetails.studio || 'N/A'}</p>
                            <p><strong>Status:</strong> ${movieDetails.owned ? 'Owned' : 'Missing'}</p>
                            ${!movieDetails.owned ? `<a href="/search?query=${encodeURIComponent(movieDetails.title)}" class="mt-4 inline-block bg-blue-600 hover:bg-blue-700 text-white font-bold py-2 px-4 rounded">Search for Download</a>` : ''}
                        </div>
                    </div>
                `;
                
                modal.classList.remove('hidden');
            });
        });

        modalClose.addEventListener('click', () => {
            modal.classList.add('hidden');
        });

        modal.addEventListener('click', (e) => {
            if (e.target === modal) {
                modal.classList.add('hidden');
            }
        });

        // Search and Filter script
        const searchInput = document.getElementById('movie-search');
        const filterCheckbox = document.getElementById('filter-missing');

        function filterAndSearch() {
            const query = searchInput.value.toLowerCase();
            const showOnlyMissing = filterCheckbox.checked;

            document.querySelectorAll('.collection-item').forEach(collection => {
                const collectionTitle = collection.querySelector('.collection-title').textContent.toLowerCase();
                const hasMissing = collection.dataset.hasMissing === 'true';
                let collectionMatch = collectionTitle.includes(query);
                let movieMatches = 0;

                collection.querySelectorAll('.movie-card').forEach(movieCard => {
                    const movieTitle = movieCard.dataset.movieTitle;
                    if (movieTitle.includes(query)) {
                        movieCard.style.display = 'block';
                        movieMatches++;
                    } else {
                        movieCard.style.display = 'none';
                    }
                });

                let showCollection = (collectionMatch || movieMatches > 0);
                if (showOnlyMissing && !hasMissing) {
                    showCollection = false;
                }

                if (showCollection) {
                    collection.style.display = 'block';
                } else {
                    collection.style.display = 'none';
                }
            });
        }

        searchInput.addEventListener('input', filterAndSearch);
        filterCheckbox.addEventListener('change', filterAndSearch);

        // Scan script
        let movieScanInProgress = false;
        let movieStatusCheckInterval;

        function updateMovieScanUI(isScanning) {
            const scanBtn = document.getElementById('run-movie-scan');
            const scanText = scanBtn.querySelector('.scan-text');
            const scanProgress = scanBtn.querySelector('.scan-progress');
            const progressContainer = document.getElementById('movieProgressContainer');

            if (isScanning) {
                scanBtn.disabled = true;
                scanText.classList.add('hidden');
                scanProgress.classList.remove('hidden');
                scanBtn.classList.add('opacity-50', 'cursor-not-allowed');
                progressContainer.classList.remove('hidden');
            } else {
                scanBtn.disabled = false;
                scanText.classList.remove('hidden');
                scanProgress.classList.add('hidden');
                scanBtn.classList.remove('opacity-50', 'cursor-not-allowed');
                progressContainer.classList.add('hidden');
            }
        }

        function checkMovieScanStatus() {
            if (!movieScanInProgress) return;

            fetch('/movie_scan_status')
                .then(res => res.json())
                .then(data => {
                    const progressBar = document.getElementById('movieScanProgressBar');
                    const scanStatus = document.getElementById('movieScanStatus');
                    const scanProgressText = document.getElementById('movieScanProgress');
                    const stopScanBtn = document.getElementById('stopMovieScanBtn');

                    progressBar.style.width = data.progress + '%';
                    scanProgressText.textContent = Math.round(data.progress) + '%';

                    let statusMsg = data.status_message;
                    if (data.in_progress && !data.stop_requested) {
                        if (data.total_collections !== 'N/A') {
                            statusMsg += ` (Movie ${data.processed_collections}/${data.total_collections})`;
                        }
                    }
                    if (data.elapsed_time) {
                        statusMsg += ` - Running for ${data.elapsed_time}`;
                    }
                    scanStatus.textContent = statusMsg;

                    if (data.stop_requested) {
                        stopScanBtn.disabled = true;
                        stopScanBtn.innerHTML = '<i class="bi bi-hourglass-split mr-1"></i> Stopping...';
                    }

                    if (!data.in_progress) {
                        clearInterval(movieStatusCheckInterval);
                        movieScanInProgress = false;
                        if (data.stop_requested) {
                            scanStatus.textContent = 'Movie scan stopped. Reloading...';
                        } else if (data.progress >= 100) {
                            scanStatus.textContent = 'Movie scan complete! Reloading...';
                        } else {
                            scanStatus.textContent = 'Movie scan finished. Reloading...';
                        }
                        setTimeout(() => {
                            window.location.reload();
                        }, 2000);
                    }
                })
                .catch(err => {
                    console.error('Movie status check error:', err);
                    clearInterval(movieStatusCheckInterval);
                    movieScanInProgress = false;
                    updateMovieScanUI(false);
                    alert("An error occurred while checking the scan status.");
                });
        }

        function runMovieScan() {
            if (movieScanInProgress) return;

            fetch('/scan_movies')
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        movieScanInProgress = true;
                        updateMovieScanUI(true);
                        movieStatusCheckInterval = setInterval(checkMovieScanStatus, 1000);
                    } else {
                        alert(data.error || 'Movie scan failed to start.');
                    }
                })
                .catch(err => {
                    console.error('Fetch error:', err);
                    alert('Failed to run movie scan.');
                });
        }

        function stopMovieScan() {
            if (!movieScanInProgress) return;

            if (!confirm('Are you sure you want to stop the movie scan? Progress so far will be saved.')) {
                return;
            }

            fetch('/stop_movie_scan')
                .then(res => res.json())
                .then(data => {
                    if (data.success) {
                        const scanStatus = document.getElementById('movieScanStatus');
                        scanStatus.textContent = 'Stopping movie scan... Saving results...';
                        document.getElementById('stopMovieScanBtn').disabled = true;
                    } else {
                        alert(data.error || 'Failed to stop movie scan.');
                    }
                })
                .catch(err => {
                    console.error('Fetch error:', err);
                    alert('Failed to stop movie scan.');
                });
        }

        document.getElementById('run-movie-scan').addEventListener('click', runMovieScan);
        document.getElementById('stopMovieScanBtn').addEventListener('click', stopMovieScan);
        
        // Check if a scan was in progress on page load
        fetch('/movie_scan_status').then(res => res.json()).then(data => {
            if (data.in_progress) {
                movieScanInProgress = true;
                updateMovieScanUI(true);
                movieStatusCheckInterval = setInterval(checkMovieScanStatus, 1000);
            }
        });
    });
</script>
{% endblock %}